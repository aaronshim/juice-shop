import { Directive, Input, isDevMode } from "@angular/core";
import qrcode from "qrcode";
import * as i0 from "@angular/core";
const validColorRegex = /^#(?:[0-9a-fA-F]{3,4}){1,2}$/;
export class QrCodeDirective {
    static { this.DEFAULT_ERROR_CORRECTION_LEVEL = "M"; }
    static { this.DEFAULT_CENTER_IMAGE_SIZE = 40; }
    constructor(viewContainerRef) {
        this.viewContainerRef = viewContainerRef;
        // eslint-disable-next-line @angular-eslint/no-input-rename
        this.errorCorrectionLevel = QrCodeDirective.DEFAULT_ERROR_CORRECTION_LEVEL;
        this.darkColor = "#000000FF";
        this.lightColor = "#FFFFFFFF";
        // eslint-disable-next-line @angular-eslint/no-input-rename
        this.margin = 16;
    }
    async ngOnChanges() {
        if (!this.value) {
            return;
        }
        if (this.version && this.version > 40) {
            console.warn("[qrCode] max version is 40, clamping");
            this.version = 40;
        }
        else if (this.version && this.version < 1) {
            console.warn("[qrCode] min version is 1, clamping");
            this.version = 1;
        }
        else if (this.version !== undefined && isNaN(this.version)) {
            console.warn("[qrCode] version should be set to a number, defaulting to auto");
            this.version = undefined;
        }
        const canvas = this.viewContainerRef.element.nativeElement;
        if (!canvas) {
            // native element not available on server side rendering
            return;
        }
        const context = canvas.getContext("2d");
        if (context) {
            context.clearRect(0, 0, context.canvas.width, context.canvas.height);
        }
        const errorCorrectionLevel = this.errorCorrectionLevel ?? QrCodeDirective.DEFAULT_ERROR_CORRECTION_LEVEL;
        const dark = validColorRegex.test(this.darkColor) ? this.darkColor : undefined;
        const light = validColorRegex.test(this.lightColor) ? this.lightColor : undefined;
        if (isDevMode()) {
            if (!dark && this.darkColor) {
                console.error("[ng-qrcode] darkColor set to invalid value, must be RGBA hex color string, eg: #3050A1FF");
            }
            if (!light && this.lightColor) {
                console.error("[ng-qrcode] lightColor set to invalid value, must be RGBA hex color string, eg: #3050A130");
            }
        }
        await qrcode
            .toCanvas(canvas, this.value, {
            version: this.version,
            errorCorrectionLevel,
            width: this.width,
            margin: this.margin,
            color: {
                dark,
                light,
            },
        });
        const centerImageSrc = this.centerImageSrc;
        const centerImageWidth = getIntOrDefault(this.centerImageWidth, QrCodeDirective.DEFAULT_CENTER_IMAGE_SIZE);
        const centerImageHeight = getIntOrDefault(this.centerImageHeight, QrCodeDirective.DEFAULT_CENTER_IMAGE_SIZE);
        if (centerImageSrc && context) {
            if (!this.centerImage) {
                this.centerImage = new Image(centerImageWidth, centerImageHeight);
            }
            const centerImage = this.centerImage;
            if (centerImageSrc !== this.centerImage.src) {
                centerImage.src = centerImageSrc;
            }
            if (centerImageWidth !== this.centerImage.width) {
                centerImage.width = centerImageWidth;
            }
            if (centerImageHeight !== this.centerImage.height) {
                centerImage.height = centerImageHeight;
            }
            const doDrawImage = () => {
                context.drawImage(centerImage, canvas.width / 2 - centerImageWidth / 2, canvas.height / 2 - centerImageHeight / 2, centerImageWidth, centerImageHeight);
            };
            centerImage.onload = doDrawImage;
            if (centerImage.complete) {
                doDrawImage();
            }
        }
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "18.0.0", ngImport: i0, type: QrCodeDirective, deps: [{ token: i0.ViewContainerRef }], target: i0.ɵɵFactoryTarget.Directive }); }
    static { this.ɵdir = i0.ɵɵngDeclareDirective({ minVersion: "14.0.0", version: "18.0.0", type: QrCodeDirective, selector: "canvas[qrCode]", inputs: { value: ["qrCode", "value"], version: ["qrCodeVersion", "version"], errorCorrectionLevel: ["qrCodeErrorCorrectionLevel", "errorCorrectionLevel"], width: "width", height: "height", darkColor: "darkColor", lightColor: "lightColor", centerImageSrc: ["qrCodeCenterImageSrc", "centerImageSrc"], centerImageWidth: ["qrCodeCenterImageWidth", "centerImageWidth"], centerImageHeight: ["qrCodeCenterImageHeight", "centerImageHeight"], margin: ["qrCodeMargin", "margin"] }, usesOnChanges: true, ngImport: i0 }); }
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "18.0.0", ngImport: i0, type: QrCodeDirective, decorators: [{
            type: Directive,
            args: [{
                    // eslint-disable-next-line @angular-eslint/directive-selector
                    selector: `canvas[qrCode]`,
                }]
        }], ctorParameters: () => [{ type: i0.ViewContainerRef }], propDecorators: { value: [{
                type: Input,
                args: ["qrCode"]
            }], version: [{
                type: Input,
                args: ["qrCodeVersion"]
            }], errorCorrectionLevel: [{
                type: Input,
                args: ["qrCodeErrorCorrectionLevel"]
            }], width: [{
                type: Input
            }], height: [{
                type: Input
            }], darkColor: [{
                type: Input
            }], lightColor: [{
                type: Input
            }], centerImageSrc: [{
                type: Input,
                args: ["qrCodeCenterImageSrc"]
            }], centerImageWidth: [{
                type: Input,
                args: ["qrCodeCenterImageWidth"]
            }], centerImageHeight: [{
                type: Input,
                args: ["qrCodeCenterImageHeight"]
            }], margin: [{
                type: Input,
                args: ["qrCodeMargin"]
            }] } });
function getIntOrDefault(value, defaultValue) {
    if (value === undefined || value === "") {
        return defaultValue;
    }
    if (typeof value === "string") {
        return parseInt(value, 10);
    }
    return value;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicXItY29kZS5kaXJlY3RpdmUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9wcm9qZWN0cy9uZy1xcmNvZGUvc3JjL2xpYi9xci1jb2RlLmRpcmVjdGl2ZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsU0FBUyxFQUFFLEtBQUssRUFBRSxTQUFTLEVBQStCLE1BQU0sZUFBZSxDQUFBO0FBQ3hGLE9BQU8sTUFBTSxNQUFNLFFBQVEsQ0FBQTs7QUFHM0IsTUFBTSxlQUFlLEdBQUcsOEJBQThCLENBQUE7QUFNdEQsTUFBTSxPQUFPLGVBQWU7YUFFVixtQ0FBOEIsR0FBK0IsR0FBRyxBQUFsQyxDQUFrQzthQUNoRSw4QkFBeUIsR0FBRyxFQUFFLEFBQUwsQ0FBSztJQTRCOUMsWUFDVSxnQkFBa0M7UUFBbEMscUJBQWdCLEdBQWhCLGdCQUFnQixDQUFrQjtRQXJCNUMsMkRBQTJEO1FBQ3RCLHlCQUFvQixHQUErQixlQUFlLENBQUMsOEJBQThCLENBQUE7UUFJN0gsY0FBUyxHQUFjLFdBQVcsQ0FBQTtRQUNsQyxlQUFVLEdBQWMsV0FBVyxDQUFBO1FBUzVDLDJEQUEyRDtRQUNwQyxXQUFNLEdBQUcsRUFBRSxDQUFBO0lBT2xDLENBQUM7SUFFRCxLQUFLLENBQUMsV0FBVztRQUNmLElBQUksQ0FBQyxJQUFJLENBQUMsS0FBSyxFQUFFLENBQUM7WUFDaEIsT0FBTTtRQUNSLENBQUM7UUFFRCxJQUFJLElBQUksQ0FBQyxPQUFPLElBQUksSUFBSSxDQUFDLE9BQU8sR0FBRyxFQUFFLEVBQUUsQ0FBQztZQUN0QyxPQUFPLENBQUMsSUFBSSxDQUFDLHNDQUFzQyxDQUFDLENBQUE7WUFDcEQsSUFBSSxDQUFDLE9BQU8sR0FBRyxFQUFFLENBQUE7UUFDbkIsQ0FBQzthQUFNLElBQUksSUFBSSxDQUFDLE9BQU8sSUFBSSxJQUFJLENBQUMsT0FBTyxHQUFHLENBQUMsRUFBRSxDQUFDO1lBQzVDLE9BQU8sQ0FBQyxJQUFJ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QkFHeUIsY0FBYztzQkFBNUMsS0FBSzt1QkFBQyxzQkFBc0I7Z0JBRUksZ0JBQWdCO3NCQUFoRCxLQUFLO3VCQUFDLHdCQUF3QjtnQkFFRyxpQkFBaUI7c0JBQWxELEtBQUs7dUJBQUMseUJBQXlCO2dCQUdULE1BQU07c0JBQTVCLEtBQUs7dUJBQUMsY0FBYzs7QUE0R3ZCLFNBQVMsZUFBZSxDQUFDLEtBQWtDLEVBQUUsWUFBb0I7SUFDL0UsSUFBSSxLQUFLLEtBQUssU0FBUyxJQUFJLEtBQUssS0FBSyxFQUFFLEVBQUUsQ0FBQztRQUN4QyxPQUFPLFlBQVksQ0FBQTtJQUNyQixDQUFDO0lBRUQsSUFBSSxPQUFPLEtBQUssS0FBSyxRQUFRLEVBQUUsQ0FBQztRQUM5QixPQUFPLFFBQVEsQ0FBQyxLQUFLLEVBQUUsRUFBRSxDQUFDLENBQUE7SUFDNUIsQ0FBQztJQUVELE9BQU8sS0FBSyxDQUFBO0FBQ2QsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IERpcmVjdGl2ZSwgSW5wdXQsIGlzRGV2TW9kZSwgT25DaGFuZ2VzLCBWaWV3Q29udGFpbmVyUmVmIH0gZnJvbSBcIkBhbmd1bGFyL2NvcmVcIlxuaW1wb3J0IHFyY29kZSBmcm9tIFwicXJjb2RlXCJcbmltcG9ydCB7IFFyQ29kZUVycm9yQ29ycmVjdGlvbkxldmVsLCBSR0JBQ29sb3IgfSBmcm9tIFwiLi90eXBlc1wiXG5cbmNvbnN0IHZhbGlkQ29sb3JSZWdleCA9IC9eIyg/OlswLTlhLWZBLUZdezMsNH0pezEsMn0kL1xuXG5ARGlyZWN0aXZlKHtcbiAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEBhbmd1bGFyLWVzbGludC9kaXJlY3RpdmUtc2VsZWN0b3JcbiAgc2VsZWN0b3I6IGBjYW52YXNbcXJDb2RlXWAsXG59KVxuZXhwb3J0IGNsYXNzIFFyQ29kZURpcmVjdGl2ZSBpbXBsZW1lbnRzIE9uQ2hhbmdlcyB7XG5cbiAgc3RhdGljIHJlYWRvbmx5IERFRkFVTFRfRVJST1JfQ09SUkVDVElPTl9MRVZFTDogUXJDb2RlRXJyb3JDb3JyZWN0aW9uTGV2ZWwgPSBcIk1cIlxuICBzdGF0aWMgcmVhZG9ubHkgREVGQVVMVF9DRU5URVJfSU1BR0VfU0laRSA9IDQwXG5cbiAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEBhbmd1bGFyLWVzbGludC9uby1pbnB1dC1yZW5hbWVcbiAgQElucHV0KFwicXJDb2RlXCIpIHZhbHVlITogc3RyaW5nXG5cbiAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEBhbmd1bGFyLWVzbGludC9uby1pbnB1dC1yZW5hbWVcbiAgQElucHV0KFwicXJDb2RlVmVyc2lvblwiKSB2ZXJzaW9uPzogbnVtYmVyXG5cbiAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEBhbmd1bGFyLWVzbGludC9uby1pbnB1dC1yZW5hbWVcbiAgQElucHV0KFwicXJDb2RlRXJyb3JDb3JyZWN0aW9uTGV2ZWxcIikgZXJyb3JDb3JyZWN0aW9uTGV2ZWw6IFFyQ29kZUVycm9yQ29ycmVjdGlvbkxldmVsID0gUXJDb2RlRGlyZWN0aXZlLkRFRkFVTFRfRVJST1JfQ09SUkVDVElPTl9MRVZFTFxuXG4gIEBJbnB1dCgpIHdpZHRoPzogbnVtYmVyXG4gIEBJbnB1dCgpIGhlaWdodD86IG51bWJlclxuICBASW5wdXQoKSBkYXJrQ29sb3I6IFJHQkFDb2xvciA9IFwiIzAwMDAwMEZGXCJcbiAgQElucHV0KCkgbGlnaHRDb2xvcjogUkdCQUNvbG9yID0gXCIjRkZGRkZGRkZcIlxuXG4gIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAYW5ndWxhci1lc2xpbnQvbm8taW5wdXQtcmVuYW1lXG4gIEBJbnB1dChcInFyQ29kZUNlbnRlckltYWdlU3JjXCIpIGNlbnRlckltYWdlU3JjPzogc3RyaW5nXG4gIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAYW5ndWxhci1lc2xpbnQvbm8taW5wdXQtcmVuYW1lXG4gIEBJbnB1dChcInFyQ29kZUNlbnRlckltYWdlV2lkdGhcIikgY2VudGVySW1hZ2VXaWR0aD86IG51bWJlciB8IHN0cmluZ1xuICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQGFuZ3VsYXItZXNsaW50L25vLWlucHV0LXJlbmFtZVxuICBASW5wdXQoXCJxckNvZGVDZW50ZXJJbWFnZUhlaWdodFwiKSBjZW50ZXJJbWFnZUhlaWdodD86IG51bWJlciB8IHN0cmluZ1xuXG4gIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAYW5ndWxhci1lc2xpbnQvbm8taW5wdXQtcmVuYW1lXG4gIEBJbnB1dChcInFyQ29kZU1hcmdpblwiKSBtYXJnaW4gPSAxNlxuXG4gIHByaXZhdGUgY2VudGVySW1hZ2U/OiBIVE1MSW1hZ2VFbGVtZW50XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSB2aWV3Q29udGFpbmVyUmVmOiBWaWV3Q29udGFpbmVyUmVmLFxuICApIHtcbiAgfVxuXG4gIGFzeW5jIG5nT25DaGFuZ2VzKCkge1xuICAgIGlmICghdGhpcy52YWx1ZSkge1xuICAgICAgcmV0dXJuXG4gICAgfVxuXG4gICAgaWYgKHRoaXMudmVyc2lvbiAmJiB0aGlzLnZlcnNpb24gPiA0MCkge1xuICAgICAgY29uc29sZS53YXJuKFwiW3FyQ29kZV0gbWF4IHZlcnNpb24gaXMgNDAsIGNsYW1waW5nXCIpXG4gICAgICB0aGlzLnZlcnNpb24gPSA0MFxuICAgIH0gZWxzZSBpZiAodGhpcy52ZXJzaW9uICYmIHRoaXMudmVyc2lvbiA8IDEpIHtcbiAgICAgIGNvbnNvbGUud2FybihcIltxckNvZGVdIG1pbiB2ZXJzaW9uIGlzIDEsIGNsYW1waW5nXCIpXG4gICAgICB0aGlzLnZlcnNpb24gPSAxXG4gICAgfSBlbHNlIGlmICh0aGlzLnZlcnNpb24gIT09IHVuZGVmaW5lZCAmJiBpc05hTih0aGlzLnZlcnNpb24pKSB7XG4gICAgICBjb25zb2xlLndhcm4oXCJbcXJDb2RlXSB2ZXJzaW9uIHNob3VsZCBiZSBzZXQgdG8gYSBudW1iZXIsIGRlZmF1bHRpbmcgdG8gYXV0b1wiKVxuICAgICAgdGhpcy52ZXJzaW9uID0gdW5kZWZpbmVkXG4gICAgfVxuXG4gICAgY29uc3QgY2FudmFzID0gdGhpcy52aWV3Q29udGFpbmVyUmVmLmVsZW1lbnQubmF0aXZlRWxlbWVudCBhcyBIVE1MQ2FudmFzRWxlbWVudCB8IG51bGxcblxuICAgIGlmICghY2FudmFzKSB7XG4gICAgICAvLyBuYXRpdmUgZWxlbWVudCBub3QgYXZhaWxhYmxlIG9uIHNlcnZlciBzaWRlIHJlbmRlcmluZ1xuICAgICAgcmV0dXJuXG4gICAgfVxuXG4gICAgY29uc3QgY29udGV4dCA9IGNhbnZhcy5nZXRDb250ZXh0KFwiMmRcIilcblxuICAgIGlmIChjb250ZXh0KSB7XG4gICAgICBjb250ZXh0LmNsZWFyUmVjdCgwLCAwLCBjb250ZXh0LmNhbnZhcy53aWR0aCwgY29udGV4dC5jYW52YXMuaGVpZ2h0KVxuICAgIH1cblxuICAgIGNvbnN0IGVycm9yQ29ycmVjdGlvbkxldmVsID0gdGhpcy5lcnJvckNvcnJlY3Rpb25MZXZlbCA/PyBRckNvZGVEaXJlY3RpdmUuREVGQVVMVF9FUlJPUl9DT1JSRUNUSU9OX0xFVkVMXG5cbiAgICBjb25zdCBkYXJrID0gdmFsaWRDb2xvclJlZ2V4LnRlc3QodGhpcy5kYXJrQ29sb3IpID8gdGhpcy5kYXJrQ29sb3IgOiB1bmRlZmluZWRcbiAgICBjb25zdCBsaWdodCA9IHZhbGlkQ29sb3JSZWdleC50ZXN0KHRoaXMubGlnaHRDb2xvcikgPyB0aGlzLmxpZ2h0Q29sb3IgOiB1bmRlZmluZWRcblxuICAgIGlmIChpc0Rldk1vZGUoKSkge1xuICAgICAgaWYgKCFkYXJrICYmIHRoaXMuZGFya0NvbG9yKSB7XG4gICAgICAgIGNvbnNvbGUuZXJyb3IoXCJbbmctcXJjb2RlXSBkYXJrQ29sb3Igc2V0IHRvIGludmFsaWQgdmFsdWUsIG11c3QgYmUgUkdCQSBoZXggY29sb3Igc3RyaW5nLCBlZzogIzMwNTBBMUZGXCIpXG4gICAgICB9XG5cbiAgICAgIGlmICghbGlnaHQgJiYgdGhpcy5saWdodENvbG9yKSB7XG4gICAgICAgIGNvbnNvbGUuZXJyb3IoXCJbbmctcXJjb2RlXSBsaWdodENvbG9yIHNldCB0byBpbnZhbGlkIHZhbHVlLCBtdXN0IGJlIFJHQkEgaGV4IGNvbG9yIHN0cmluZywgZWc6ICMzMDUwQTEzMFwiKVxuICAgICAgfVxuICAgIH1cbiAgICBhd2FpdCBxcmNvZGVcbiAgICAgIC50b0NhbnZhcyhjYW52YXMsIHRoaXMudmFsdWUsIHtcbiAgICAgICAgdmVyc2lvbjogdGhpcy52ZXJzaW9uLFxuICAgICAgICBlcnJvckNvcnJlY3Rpb25MZXZlbCxcbiAgICAgICAgd2lkdGg6IHRoaXMud2lkdGgsXG4gICAgICAgIG1hcmdpbjogdGhpcy5tYXJnaW4sXG4gICAgICAgIGNvbG9yOiB7XG4gICAgICAgICAgZGFyayxcbiAgICAgICAgICBsaWdodCxcbiAgICAgICAgfSxcbiAgICAgIH0pXG5cbiAgICBjb25zdCBjZW50ZXJJbWFnZVNyYyA9IHRoaXMuY2VudGVySW1hZ2VTcmNcbiAgICBjb25zdCBjZW50ZXJJbWFnZVdpZHRoID0gZ2V0SW50T3JEZWZhdWx0KHRoaXMuY2VudGVySW1hZ2VXaWR0aCwgUXJDb2RlRGlyZWN0aXZlLkRFRkFVTFRfQ0VOVEVSX0lNQUdFX1NJWkUpXG4gICAgY29uc3QgY2VudGVySW1hZ2VIZWlnaHQgPSBnZXRJbnRPckRlZmF1bHQodGhpcy5jZW50ZXJJbWFnZUhlaWdodCwgUXJDb2RlRGlyZWN0aXZlLkRFRkFVTFRfQ0VOVEVSX0lNQUdFX1NJWkUpXG5cbiAgICBpZiAoY2VudGVySW1hZ2VTcmMgJiYgY29udGV4dCkge1xuXG4gICAgICBpZiAoIXRoaXMuY2VudGVySW1hZ2UpIHtcbiAgICAgICAgdGhpcy5jZW50ZXJJbWFnZSA9IG5ldyBJbWFnZShjZW50ZXJJbWFnZVdpZHRoLCBjZW50ZXJJbWFnZUhlaWdodClcbiAgICAgIH1cblxuICAgICAgY29uc3QgY2VudGVySW1hZ2UgPSB0aGlzLmNlbnRlckltYWdlXG5cbiAgICAgIGlmIChjZW50ZXJJbWFnZVNyYyAhPT0gdGhpcy5jZW50ZXJJbWFnZS5zcmMpIHtcbiAgICAgICAgY2VudGVySW1hZ2Uuc3JjID0gY2VudGVySW1hZ2VTcmNcbiAgICAgIH1cblxuICAgICAgaWYgKGNlbnRlckltYWdlV2lkdGggIT09IHRoaXMuY2VudGVySW1hZ2Uud2lkdGgpIHtcbiAgICAgICAgY2VudGVySW1hZ2Uud2lkdGggPSBjZW50ZXJJbWFnZVdpZHRoXG4gICAgICB9XG5cbiAgICAgIGlmIChjZW50ZXJJbWFnZUhlaWdodCAhPT0gdGhpcy5jZW50ZXJJbWFnZS5oZWlnaHQpIHtcbiAgICAgICAgY2VudGVySW1hZ2UuaGVpZ2h0ID0gY2VudGVySW1hZ2VIZWlnaHRcbiAgICAgIH1cblxuICAgICAgY29uc3QgZG9EcmF3SW1hZ2UgPSAoKSA9PiB7XG4gICAgICAgIGNvbnRleHQuZHJhd0ltYWdlKFxuICAgICAgICAgIGNlbnRlckltYWdlLFxuICAgICAgICAgIGNhbnZhcy53aWR0aCAvIDIgLSBjZW50ZXJJbWFnZVdpZHRoIC8gMixcbiAgICAgICAgICBjYW52YXMuaGVpZ2h0IC8gMiAtIGNlbnRlckltYWdlSGVpZ2h0IC8gMiwgY2VudGVySW1hZ2VXaWR0aCwgY2VudGVySW1hZ2VIZWlnaHQsXG4gICAgICAgIClcbiAgICAgIH1cblxuICAgICAgY2VudGVySW1hZ2Uub25sb2FkID0gZG9EcmF3SW1hZ2VcblxuICAgICAgaWYgKGNlbnRlckltYWdlLmNvbXBsZXRlKSB7XG4gICAgICAgIGRvRHJhd0ltYWdlKClcbiAgICAgIH1cblxuICAgIH1cblxuICB9XG5cbn1cblxuZnVuY3Rpb24gZ2V0SW50T3JEZWZhdWx0KHZhbHVlOiBzdHJpbmcgfCBudW1iZXIgfCB1bmRlZmluZWQsIGRlZmF1bHRWYWx1ZTogbnVtYmVyKTogbnVtYmVyIHtcbiAgaWYgKHZhbHVlID09PSB1bmRlZmluZWQgfHwgdmFsdWUgPT09IFwiXCIpIHtcbiAgICByZXR1cm4gZGVmYXVsdFZhbHVlXG4gIH1cblxuICBpZiAodHlwZW9mIHZhbHVlID09PSBcInN0cmluZ1wiKSB7XG4gICAgcmV0dXJuIHBhcnNlSW50KHZhbHVlLCAxMClcbiAgfVxuXG4gIHJldHVybiB2YWx1ZVxufVxuIl19